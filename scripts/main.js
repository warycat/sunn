function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function xy(a,b){$.ajax({url:"http://"+ip+"/api/sunndeveloper/groups/"+group+"/action",type:"PUT",data:JSON.stringify({on:!0,xy:[a,b],bri:brightness})}).done(function(a){console.log(JSON.stringify(a))})}function hexToRgb(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null}Modernizr.addTest("iphone",function(){return!!navigator.userAgent.match(/iPhone/i)});var ip=getParameterByName("ip"),citycode=getParameterByName("citycode"),backurl=getParameterByName("backurl"),cityurl=getParameterByName("cityurl"),speed=getParameterByName("speed"),group=getParameterByName("group"),brightness=getParameterByName("brightness");console.log(ip,citycode,backurl,cityurl,speed),$.getJSON(cityurl+"?citycode="+citycode,function(a){if(a){paper.install(window);var b=0,c=$(window).width(),d=$(window).height(),e=function(){var e=function(){return moment().add(speed*b,"second")},f=a.sunrise[0],g=a.sunrise[1],h=a.sunset[0],i=a.sunset[1],j=function(){return c},k=function(){return d},l=function(){return new Point(c,d)},m=4,n=Modernizr.iphone?75:150,o=Modernizr.iphone?5:10,p=new Point(j()/2,k()/2),q=a.sun,r=a.ray,s=function(a){function b(a,b,c,d,e){return(a+(b-a)*(d-c)/d)/e}var c=e().hour(),d=e().minute(),f=hexToRgb(a[c]),g=hexToRgb(a[(c+1)%24]);return new Color(b(f.r,g.r,d,60,255),b(f.g,g.g,d,60,255),b(f.b,g.b,d,60,255))},t=function(){return s(q)},u=function(){return s(r)},v="#104eb3",w="#1188f2",x="#0d73cc",y=[v,w,x],z=function(){return new Point(0,0)},A=function(){return new Point(j()/2,0)},B=function(){return new Point(j(),0)},C=function(){return new Point(0,k()/2)},D=function(){return new Point(j()/2,k()/2)},E=function(){return new Point(j(),k()/2)},F=function(){return new Point(0,k())},G=function(){return new Point(j()/2,k())},H=function(){return new Point(j(),k())},I="Lights synched with sunn",J="Lights synched with firelight",K=Modernizr.iphone?16:40,L=Modernizr.iphone?.3:.5,M="#ffffff",N=new Point(j()/2,Modernizr.iphone?40:80),O=function(){var a=e().format("hh"),b=e().format("mm"),c=moment().format("s");return a+(c%2?":":" ")+b},P=Modernizr.iphone?40:80,Q="#e18422",R=new Point(j()/2,k()/2+(Modernizr.iphone?10:20)),S=function(){return e().format("MMM Do, YYYY")},T=Modernizr.iphone?10:20,U="#e18422",V=new Point(j()/2,k()/2+(Modernizr.iphone?20:40)),W=a.cityname,X=Modernizr.iphone?15:30,Y="#ffffff",Z=new Point(j()/2,k()-(Modernizr.iphone?25:45)),$=new Point(Modernizr.iphone?30:60,Modernizr.iphone?40:80),_=Modernizr.iphone?.15:.3,ab=new Point(j()/2-(Modernizr.iphone?100:200),k()-(Modernizr.iphone?30:60)),bb=Modernizr.iphone?.05:.1,cb=Modernizr.iphone?20:40,db=[j()/2,k()/2+(Modernizr.iphone?50:100)],eb=Modernizr.iphone?.25:.5,fb=E(),gb=Modernizr.iphone?25:50,hb=Modernizr.iphone?2:5,ib=new Point(fb.x-gb,fb.y),jb=new Point(fb.x,fb.y),kb=Modernizr.iphone?75:150,lb=Modernizr.iphone?10:20,mb=Modernizr.iphone?2:3,nb=Modernizr.iphone?12:20,ob=Modernizr.iphone?5:10,pb=1,qb=new Point(E());return{currentMoment:e,sunriseHour:f,sunriseMinute:g,sunsetHour:h,sunsetMinute:i,width:j,height:k,size:l,sunLayers:m,radius:n,center:p,increment:o,sunColor:t,rayColor:u,skyColors:y,topLeft:z,topMiddle:A,topRight:B,middleLeft:C,middleMiddle:D,middleRight:E,bottomLeft:F,bottomMiddle:G,bottomRight:H,titleTextDay:I,titleTextNight:J,titlePosition:N,titleSize:K,titleColor:M,titleScale:L,clockText:O,clockSize:P,clockColor:Q,clockPosition:R,dateText:S,dateSize:T,dateColor:U,datePosition:V,cityText:W,citySize:X,cityColor:Y,cityPosition:Z,iconPosition:$,iconScale:_,globePosition:ab,globeScale:bb,globeRadius:cb,campfirePosition:db,campfireScale:eb,markF:ib,markT:jb,markWidth:hb,rulerZeroPosition:qb,rulerSpacing:kb,rulerWidth:mb,rulerLength:lb,rulerTextSize:nb,rulerTextSpacing:ob,rulerDirection:pb}}();console.log(e);var f=function(){function c(){var a=e.currentMoment().hour()%12;this.visible=this.h-1<a?!1:!0}$("<canvas resize></canvas>").appendTo($("body"));var d=$("canvas")[0];paper.setup(d),Path.Rectangle({point:[0,0],size:e.size(),fillColor:{gradient:{stops:[["#162883",0],["#1983db",.5]]},origin:e.topMiddle(),destination:e.bottomMiddle()}}).onFrame=function(){this.size=e.size()};var f=new Path.Rectangle({point:e.middleLeft(),size:[e.width(),-100],fillColor:{gradient:{stops:[["#000000",0],[new Color(0,0,1,0),1]]},origin:e.middleMiddle(),destination:[e.width()/2,e.height()/2-100]}});f.offset=0;var g=new Path.Rectangle({point:e.middleLeft(),size:[e.width(),-100],fillColor:{gradient:{stops:[["#000000",0],[new Color(0,0,1,0),1]]},origin:e.middleMiddle(),destination:[e.width()/2,e.height()/2-100]}});g.offset=0;var h=new Path.Circle({center:e.middleMiddle(),radius:e.radius,fillColor:e.sunColor(),onFrame:function(){this.center=e.middleMiddle(),this.fillColor=e.sunColor()}}),i=new Path.Rectangle({point:e.middleLeft(),size:[e.width(),2*e.height()],strokeColor:"black",strokeWidth:e.markWidth,fillColor:"black"});i.offset=0;var j=new Path.Rectangle({point:e.middleLeft(),size:[e.width(),2*e.height()],strokeColor:"black",strokeWidth:e.markWidth,fillColor:"black"});j.offset=0,new Path.Line({from:e.markF,to:e.markT,strokeColor:"white",strokeWidth:e.markWidth,strokeCap:"round"});for(var k=new Group,l=new Group,m=0;12>=m;m++){var n=new Path.Line({from:new Point(e.rulerZeroPosition.x-e.rulerLength,e.rulerZeroPosition.y+m*e.rulerDirection*e.rulerSpacing),to:new Point(e.rulerZeroPosition.x,e.rulerZeroPosition.y+m*e.rulerDirection*e.rulerSpacing),strokeColor:"white",strokeWidth:e.rulerWidth,strokeCap:"square"}),o=new PointText({point:new Point(e.rulerZeroPosition.x-e.rulerLength-e.rulerTextSpacing,e.rulerZeroPosition.y+m*e.rulerDirection*e.rulerSpacing+7),content:m+"",justification:"right",fillColor:"white",fontSize:e.rulerTextSize});k.addChild(n),k.addChild(o);var p=new Path.Line({from:new Point(e.rulerZeroPosition.x-e.rulerLength,e.rulerZeroPosition.y-m*e.rulerDirection*e.rulerSpacing),to:new Point(e.rulerZeroPosition.x,e.rulerZeroPosition.y-m*e.rulerDirection*e.rulerSpacing),strokeColor:"white",strokeWidth:e.rulerWidth,strokeCap:"square"}),q=new PointText({point:new Point(e.rulerZeroPosition.x-e.rulerLength-e.rulerTextSpacing,e.rulerZeroPosition.y-m*e.rulerDirection*e.rulerSpacing+7),content:m+"",justification:"right",fillColor:"white",fontSize:e.rulerTextSize});l.addChild(p),l.addChild(q),n.h=m,p.h=m,o.h=m,q.h=m,n.onFrame=c,p.onFrame=c,o.onFrame=c,q.onFrame=c}k.offset=0,l.offset=0,k.onFrame=function(){k.translate(new Point(0,+k.offset)),k.offset=12*e.rulerSpacing*(e.currentMoment().minute()+e.currentMoment().hour()%12*60)/720,k.translate(new Point(0,-k.offset))},l.onFrame=function(){l.translate(new Point(0,-l.offset)),l.offset=12*e.rulerSpacing*(e.currentMoment().minute()+e.currentMoment().hour()%12*60)/720,l.translate(new Point(0,+l.offset))};var r=new Path.Circle({center:e.middleMiddle(),radius:e.radius+3*e.increment,fillColor:"#d55707",opacity:.1}),s=new Path.Circle({center:e.middleMiddle(),radius:e.radius+2*e.increment,fillColor:"#d55707",opacity:.5}),t=new Path.Circle({center:e.middleMiddle(),radius:e.radius+e.increment,fillColor:"#d55707",opacity:1}),u=new Path.Circle({center:e.middleMiddle(),radius:e.radius,fillColor:"black",opacity:1}),v=new Raster({source:"https://cloud.githubusercontent.com/assets/5893062/4180267/ade33f90-36f0-11e4-83bd-ab7d8eb6b9cf.PNG",position:e.campfirePosition}).scale(e.campfireScale),w=new Group([r,s,t,u,v]);new PointText({point:e.clockPosition,content:e.clockText(),fillColor:e.clockColor,justification:"center",fontFamily:"arial,helvetica",fontSize:e.clockSize,onFrame:function(){this.content=e.clockText(),this.fillColor=e.rayColor()}}),new PointText({point:e.datePosition,content:e.dateText(),fillColor:e.dateColor,justification:"center",fontFamily:"arial,helvetica",fontSize:e.dateSize,onFrame:function(){this.content=e.dateText(),this.fillColor=e.rayColor()}});var z=new Raster({source:"https://cloud.githubusercontent.com/assets/5893062/4180451/fc2fef3e-36f7-11e4-9ae9-8cbd4942f450.PNG",position:e.iconPosition}).scale(e.iconScale);z.onMouseUp=function(){console.log("icon"),window.location.href=backurl};var A=new Raster({source:"https://cloud.githubusercontent.com/assets/5893062/4258419/4b906b52-3ad2-11e4-9431-4b2bc6c8aec9.png",position:e.titlePosition}).scale(e.titleScale),B=new Raster({source:"https://cloud.githubusercontent.com/assets/5893062/4258418/494fb8ca-3ad2-11e4-9daf-7951a4265c1f.png",position:e.titlePosition}).scale(e.titleScale);new Path.Circle({radius:e.globeRadius,center:e.globePosition,fillColor:"white",opacity:.5}),new PointText({point:e.cityPosition,content:e.cityText,fillColor:e.cityColor,justification:"center",fontFamily:"arial,helvetica",fontSize:e.citySize}),new Raster({source:"https://cloud.githubusercontent.com/assets/1858099/3948392/b56e30e6-26a4-11e4-9bcd-7f35cf3e3755.png",position:e.globePosition,opacity:.5}).scale(e.globeScale),f.onFrame=function(){this.point=e.middleLeft(),this.size=[e.width(),-100],f.translate(new Point(0,-f.offset)),f.offset=12*e.rulerSpacing*(e.currentMoment().minute()-e.sunriseMinute+60*(e.currentMoment().hour()%12-e.sunriseHour))/720,f.translate(new Point(0,+f.offset))},g.onFrame=function(){this.point=e.middleLeft(),this.size=[e.width(),-100],g.translate(new Point(0,+g.offset)),g.offset=12*e.rulerSpacing*(e.currentMoment().minute()-e.sunsetMinute+60*(e.currentMoment().hour()%12-e.sunsetHour))/720,g.translate(new Point(0,-g.offset))},i.onFrame=function(){this.point=e.middleLeft(),this.size=[e.width(),2*e.height()],i.translate(new Point(0,-i.offset)),i.offset=12*e.rulerSpacing*(e.currentMoment().minute()-e.sunriseMinute+60*(e.currentMoment().hour()%12-e.sunriseHour))/720,i.translate(new Point(0,+i.offset))},j.onFrame=function(){this.point=e.middleLeft(),this.size=[e.width(),2*e.height()],j.translate(new Point(0,+j.offset)),j.offset=12*e.rulerSpacing*(e.currentMoment().minute()-e.sunsetMinute+60*(e.currentMoment().hour()%12-e.sunsetHour))/720,j.translate(new Point(0,-j.offset))},view.onFrame=function(c){b=c.count,function(){if(b%30===0){var a=new Path.Circle({center:e.center,radius:e.radius,fillColor:e.sunColor(),opacity:1,onFrame:function(){this.scale(1.003),this.life--,this.opacity=this.life/100,0===this.life&&this.remove()}});a.life=100,a.insertBelow(h)}}();var d=e.currentMoment().hour(),m=e.currentMoment().minute(),n=e.currentMoment().second();n%5===0&&a.xys[d][m]&&(x=a.xys[d][m][0],y=a.xys[d][m][1],xy(x,y)),12>d?(k.visible=!1,l.visible=!0,f.visible=!0,i.visible=!0,g.visible=!1,j.visible=!1):(l.visible=!1,k.visible=!0,f.visible=!1,i.visible=!1,g.visible=!0,j.visible=!0),d<e.sunriseHour||d>12+e.sunsetHour?(w.visible=!0,A.visible=!1,B.visible=!0):(w.visible=!1,A.visible=!0,B.visible=!1)}};f()}});